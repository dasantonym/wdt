/*! wdt webkit - v1.9.1 - 2015-03-22 */

!function(){"use strict";angular.module("app",["ngRoute","wdt.controllers.appear-disappear","wdt.controllers.capture-replay","wdt.controllers.main","wdt.controllers.reverse-delay","wdt.controllers.skel","wdt.controllers.space"]).config(["$routeProvider","$logProvider",function(a,b){b.debugEnabled(!0);var c="views/";a.when("/",{templateUrl:c+"main.html",controller:"Main"}),a.when("/appear-disappear",{templateUrl:c+"appear-disappear.html",controller:"AppearDisappear"}),a.when("/capture-replay",{templateUrl:c+"capture-replay.html",controller:"CaptureReplay"}),a.when("/reverse-delay",{templateUrl:c+"reverse-delay.html",controller:"ReverseDelay"}),a.when("/space/:spaceModule",{templateUrl:c+"space.html",controller:"Space"})}])}(),function(){"use strict";angular.module("wdt.controllers.appear-disappear",[]).controller("AppearDisappear",["$scope",function(a){var b=require("opencv"),c=document.getElementById("canvas"),d=c.getContext("2d"),e=document.getElementById("video-container"),f=document.getElementById("canvas-container"),g=document.getElementById("OSD"),h=320,i=240,j=new b.VideoCapture(0),k=new b.Average;j.setWidth(h),j.setHeight(i),window.onresize=function(){var a=window.innerWidth,b=window.innerHeight,c=Math.min(a/h,b/i);f.style.webkitTransform="scale("+c+","+c+")";var d=(a-h)/2,j=(b-i)/2;e.style.left=""+d+"px",e.style.top=""+j+"px",g.style.left=""+(a-h*c)/2+"px",g.style.top=""+(b-i*c)/2+"px"},document.onkeydown=function(b){switch(b.keyCode){case 81:j.close(),k=void 0,j=void 0,window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()};var l=0,m=function(){j.read(function(a,b){k.process(b,.01);for(var c=d.createImageData(b.width(),b.height()),e=b.width(),f=b.height(),g=0;f>g;g+=1)for(var h=0;e>h;h+=1){var i=b.pixel(g,h),j=4*(e*g+h);c.data[j]=i[2],c.data[j+1]=i[1],c.data[j+2]=i[0],c.data[j+3]=255}d.putImageData(c,0,0),l+=1,100>l&&window.setTimeout(m,10)})};window.onresize(),m()}])}(),function(){"use strict";angular.module("wdt.controllers.capture-replay",[]).controller("CaptureReplay",["$scope",function(a){function b(){i="countdown";var b,c=4;(b=function(){c--,0>=c?(i="record",j=[]):(a.toGo=c,setTimeout(b,1e3))})()}function c(){i="replay",m=0,n=1}function d(){i="reverse",m=l-1,n=-1}function e(){i="slowmotion",m=0,n=.33}var f=document.getElementById("canvas"),g=f.getContext("2d"),h=require("gstreamer-superficial"),i="menu",j=[],k=25,l=4*k,m=0,n=0,o=320,p=240,q={record:{x:.025,y:.525,w:.1,h:.1},replay:{x:.3,y:.525,w:.1,h:.1},reverse:{x:.45,y:.525,w:.1,h:.1},slowmotion:{x:.6,y:.525,w:.1,h:.1}},r="v4l2src ! tee name=t0  t0. ! queue max-size-buffers=1 ! videoconvert ! motion weight=0.3";for(var s in q){var t=q[s];r+=" ! triggers x="+t.x+" y="+t.y+" w="+t.w+" h="+t.h+" name="+s}r+=" ! fakesink  t0. ! queue max-size-buffers=1 ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink";var u=new h.Pipeline(r),v=u.findChild("sink");for(s in q)q[s].trigger=u.findChild(s);var w=document.getElementById("video-container"),x=document.getElementById("canvas-container"),y=document.getElementById("OSD");window.onresize=function(){var a=window.innerWidth,b=window.innerHeight,c=Math.min(a/o,b/p);x.style.webkitTransform="scale("+c+","+c+")";var d=(a-o)/2,e=(b-p)/2;w.style.left=""+d+"px",w.style.top=""+e+"px",y.style.left=""+(a-o*c)/2+"px",y.style.top=""+(b-p*c)/2+"px"},window.onresize(),document.onkeydown=function(f){switch(f.keyCode){case 82:b();break;case 65:c();break;case 83:d();break;case 68:e();break;case 81:u.stop(),window.location="index.html";break;default:console.log("unhandled key code "+f.keyCode)}a.$apply()},v.pull(function(b){var c=g.createImageData(o,p);switch(c.data.set(b),i){case"menu":g.putImageData(c,0,0);for(s in q){var d=q[s];g.fillStyle="rgba(255,0,0,"+d.trigger.get("value")+")",g.fillRect(d.x*o,d.y*p,d.w*o,d.h*p),g.strokeStyle="#f00",g.lineWidth=1,g.strokeRect(d.x*o,d.y*p,d.w*o,d.h*p),d.trigger.get("ping")&&console.log("PING "+s)}break;case"countdown":g.putImageData(c,0,0);break;case"record":g.putImageData(c,0,0),j.push(c),j.length>=l&&(i="menu"),a.toGo=(l-j.length)/k;break;case"replay":case"reverse":case"slowmotion":m+=n;var e=Math.round(m);0>e||e>=j.length?i="menu":g.putImageData(j[e],0,0),a.debug={pos:e,speed:n};break;default:g.clearRect(0,0,o,p)}a.mode=i,a.$apply()},function(){}),a.$on("$routeChangeStart",function(a,b){a!==b&&u.stop()}),u.play()}])}(),function(){"use strict";angular.module("wdt.controllers.main",[]).controller("Main",["$scope",function(a){a.tools=[{name:"Matching Positions",href:"#/space/positions",img:"img/matching-positions.png"},{name:"Inertia",href:"#/space/inertia",img:"img/inertia.png"},{name:"Cage",href:"#/space/cage",img:"img/cage.png"},{name:"Reverse and Delay",href:"#/reverse-delay",img:"img/reverse-and-delay.png"},{name:"Capture and Replay",href:"#/capture-replay",img:"img/capture-and-replay.png"},{name:"Appear - Disappear",href:"#/appear-disappear",img:"img/appear-disappear.png"}],a.toolRows=[];var b=[];for(var c in a.tools)b.push(a.tools[c]),3==b.length&&(a.toolRows.push(b),b=[]);a.toolRows.push(b),document.onkeydown=function(b){var c=b.keyCode-49;if(c>=0&&c<a.tools.length)return void(window.location=a.tools[c].href);switch(b.keyCode){case 81:global.window.nwDispatcher.requireNwGui().App.quit();default:console.log("unhandled key code "+b.keyCode)}}}])}(),function(){"use strict";angular.module("wdt.controllers.reverse-delay",[]).controller("ReverseDelay",["$scope",function(a){function b(a){a.beginPath(),a.moveTo(0,0),a.lineTo(3,7),a.lineTo(-3,7),a.closePath(),a.fill()}a.mode="Delay";var c=[],d=25,e=100,f=0,g=0,h=1;a.duration=e/d,a.changeBuffer=function(b){var i=e/d;switch(i+=b,1>i&&(i=1),i>10&&(i=10),e=i*d,c=[],a.mode){case"Delay":h=1,g=0,f=1;break;case"Reverse":h=-1,g=0,f=e-1}a.duration=i},a.switchMode=function(){"Delay"==a.mode?(a.mode="Reverse",h=-1,g=0,f=e-1):(a.mode="Delay",h=1,g=0,f=1)};var i=document.getElementById("canvas"),j=i.getContext("2d"),k=require("gstreamer-superficial"),l=320,m=240,n=new k.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),o=n.findChild("sink"),p=document.getElementById("video-container"),q=document.getElementById("canvas-container"),r=document.getElementById("OSD");window.onresize=function(){var a=window.innerWidth,b=window.innerHeight,c=Math.min(a/l,b/m);q.style.webkitTransform="scale("+c+","+c+")";var d=(a-l)/2,e=(b-m)/2;p.style.left=""+d+"px",p.style.top=""+e+"px",r.style.left=""+(a-l*c)/2+"px",r.style.top=""+(b-m*c)/2+"px"},window.onresize(),document.onkeydown=function(b){switch(b.keyCode){case 38:a.changeBuffer(1);break;case 40:a.changeBuffer(-1);break;case 39:a.switchMode();break;case 37:a.switchMode();break;case 81:n.stop(),window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()},o.pull(function(d){var i=j.createImageData(l,m);for(i.data.set(d),c[g]=i,g=(g+1)%e,f=(f+h)%e;0>f;)f=e-1;a.frames=c.length,a.playPosition=f,a.recordPosition=g,c.length>f?j.putImageData(c[f],0,0):j.clearRect(0,0,l,m);var k=150,n=10,o=150;j.strokeStyle="#fff",j.lineWidth=1,j.beginPath(),j.moveTo(k,n),j.lineTo(k+o,n),j.stroke(),j.save(),j.translate(k+o*g/e,n),j.fillStyle="#f00",b(j),j.restore(),j.save(),j.translate(k+o*f/e,n),j.fillStyle="#0f0",b(j),j.restore(),a.$apply()},function(){}),a.$on("$routeChangeStart",function(a,b){a!==b&&n.stop()}),n.play()}])}(),function(){"use strict";angular.module("wdt.controllers.skel",[]).controller("Skel",["$scope",function(a){var b=document.getElementById("canvas"),c=b.getContext("2d"),d=require("gstreamer-superficial"),e=320,f=240,g=new d.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),h=g.findChild("sink"),i=document.getElementById("video-container"),j=document.getElementById("canvas-container"),k=document.getElementById("OSD");window.onresize=function(){var a=window.innerWidth,b=window.innerHeight,c=Math.min(a/e,b/f);j.style.webkitTransform="scale("+c+","+c+")";var d=(a-e)/2,g=(b-f)/2;i.style.left=""+d+"px",i.style.top=""+g+"px",k.style.left=""+(a-e*c)/2+"px",k.style.top=""+(b-f*c)/2+"px"},window.onresize(),document.onkeydown=function(b){switch(b.keyCode){case 81:g.stop(),window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()},h.pull(function(b){var d=c.createImageData(e,f);d.data.set(b),c.putImageData(d,0,0),a.$apply()},function(){}),a.$on("$routeChangeStart",function(a,b){a!==b&&g.stop()}),g.play()}])}(),function(){"use strict";angular.module("wdt.controllers.space",[]).controller("Space",["$scope","$routeParams",function(a,b){function c(a){return a/180*-Math.PI}switch(b.spaceModule){case"inertia":a.exercises=[{type:"Inertia"}];break;case"cage":a.exercises=[{type:"Cage",left:.2,top:.2,right:.8,bottom:1.1},{type:"Cage",left:.35,top:.15,right:.6,bottom:1.1}];break;default:a.exercises=[{type:"StandAtAngle",angle:45},{type:"StandAtAngle",angle:0},{type:"StandAtAngle",angle:180},{type:"StandAtAngle",angle:316},{type:"MoveTo",x:.8,y:.7},{type:"StandAtAngle",angle:95},{type:"MoveTo",x:.1,y:.75},{type:"StandAtAngle",angle:212},{type:"StandAtAngle",angle:114},{type:"MoveTo",x:.9,y:.23}]}a.exerciseIndex=0,a.exercise=a.exercises[a.exerciseIndex],a.nextExercise=function(){a.exerciseIndex=(a.exerciseIndex+1)%a.exercises.length,a.exercise=a.exercises[a.exerciseIndex]},a.previousExercise=function(){a.exerciseIndex=(a.exerciseIndex-1)%a.exercises.length,a.exerciseIndex<0&&(a.exerciseIndex=a.exercises.length-1),a.exercise=a.exercises[a.exerciseIndex]},a.exerciseDone=function(){a.nextExercise()},a.OSDOpacity=0;var d;a.showOSD=function(){a.OSDOpacity=1,d||(d=setInterval(function(){a.OSDOpacity*=.9,a.OSDOpacity<.01&&(a.OSDOpacity=0,clearInterval(d),d=void 0),a.$apply()},66))},a.threshold=100;var e=document.getElementById("canvas"),f=e.getContext("2d"),g=320,h=240;a.inert={x:g/2,y:h/2},a.vel={x:0,y:0};var i,j=require("opencv"),k=new j.VideoCapture(0),l=new j.Extremes;k.setWidth(g),k.setHeight(h);var m=document.getElementById("video-container"),n=document.getElementById("canvas-container"),o=document.getElementById("OSD");window.onresize=function(){var a=window.innerWidth,b=window.innerHeight,c=Math.min(a/g,b/h);n.style.webkitTransform="scale("+c+","+c+")";var d=(a-g)/2,e=(b-h)/2;m.style.left=""+d+"px",m.style.top=""+e+"px",o.style.left=""+(a-g*c)/2+"px",o.style.top=""+(b-h*c)/2+"px"},document.onkeydown=function(b){switch(b.keyCode){case 38:a.threshold=Math.min(255,a.threshold+3),a.showOSD();break;case 40:a.threshold=Math.max(0,a.threshold-3),a.showOSD();break;case 39:a.nextExercise();break;case 37:a.previousExercise();break;case 32:motion.set("reset",!0);break;case 81:k.close(),k=void 0,window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()};var p=0,q=function(){k.read(function(b,d){d.convertGrayscale(),d.cvtColor("CV_GRAY2BGR");var e=l.process(d);d=d.threshold(a.threshold,255);var g;if(i?g=i.track(d):i=new j.TrackedObject(d,[0,0,320,240],{channel:"value"}),!g)return void(100>p&&window.setTimeout(q,10));for(var h=f.createImageData(d.width(),d.height()),k=d.width(),m=d.height(),n=0;m>n;n+=1)for(var o=0;k>o;o+=1){var r=d.pixel(n,o),s=4*(k*n+o);h.data[s]=r[2],h.data[s+1]=r[1],h.data[s+2]=r[0],h.data[s+3]=255}f.putImageData(h,0,0);var t=a.extremes={left:e[0]*k,top:e[2]*m,right:e[1]*k,bottom:e[3]*m},u=a.centroid={x:g[0],y:g[1],width:g[2],height:g[3],angle:c(g[4])};f.fillStyle="#fff",f.save(),f.translate(u.x,u.y),f.rotate(u.angle),f.fillRect(-(u.width/2),-5,u.width,10),f.fillRect(-5,-(u.height/2),10,u.height),f.restore(),f.strokeStyle="#f00",f.lineWidth=2,f.strokeRect(t.left,t.top,t.right-t.left,t.bottom-t.top);var v=.05,w=1-v,x=a.inert,y=a.vel,z={x:u.x-x.x,y:u.y-x.y};z.x*=v,z.y*=v,y.x*=w,y.y*=w,y.x+=z.x,y.y+=z.y,x.x+=y.x,x.y+=y.y,a.inert=x,a.vel=y;var A=a.exercise;f.fillStyle="#fff";var B=2,C=30;switch(f.save(),A.type){case"StandAtAngle":var D=c(A.angle);f.translate(k/2,m/2),f.rotate(D),f.fillRect(-k/2,-2,k,4);var E=Math.abs(D-u.angle);a.delta=E,E<c(3)&&a.exerciseDone();break;case"MoveTo":var o=A.x*k,n=A.y*m;f.fillRect(o-B,n-C,2*B,2*C),f.fillRect(o-C,n-B,2*C,2*B);var z={x:o-u.x,y:n-u.y},E=Math.sqrt(z.x*z.x+z.y*z.y);a.delta=E,10>E&&a.exerciseDone();break;case"Cage":var F={l:A.left*k,t:A.top*m,r:A.right*k,b:A.bottom*m},G=F.l<t.left&&F.t<t.top&&F.r>t.right&&F.b>=t.bottom;a.insideCage=G,f.strokeStyle=G?"#0f0":"#f00",f.lineWidth=2,f.strokeRect(F.l,F.t,F.r-F.l,F.b-F.t);break;case"Inertia":var o=a.inert.x,n=a.inert.y;f.fillRect(o-B,n-C,2*B,2*C),f.fillRect(o-C,n-B,2*C,2*B)}f.restore(),a.$apply(),window.setTimeout(q,10)})};a.$on("$routeChangeStart",function(a,b){a!==b&&(k.close(),k=void 0)}),window.onresize(),q()}])}();