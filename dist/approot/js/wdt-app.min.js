/*! wdt webkit - v2.0.0 - 2015-04-28 */

!function(){"use strict";angular.module("app",["ngRoute","wdt.controllers.appear-disappear","wdt.controllers.capture-replay","wdt.controllers.main","wdt.controllers.reverse-delay","wdt.controllers.skel","wdt.controllers.space"]).config(["$routeProvider","$logProvider",function(a,b){b.debugEnabled(!0);var c="views/";a.when("/",{templateUrl:c+"main.html",controller:"Main"}),a.when("/appear-disappear",{templateUrl:c+"appear-disappear.html",controller:"AppearDisappear"}),a.when("/capture-replay",{templateUrl:c+"capture-replay.html",controller:"CaptureReplay"}),a.when("/reverse-delay",{templateUrl:c+"reverse-delay.html",controller:"ReverseDelay"}),a.when("/space/:spaceModule",{templateUrl:c+"space.html",controller:"Space"})}]).run(function(){var a=require("nw.gui"),b=require("os"),c=a.Window.get(),d=new a.Menu({type:"menubar"});"darwin"===b.platform()&&(d.createMacBuiltin("WDT"),c.menu=d)})}(),function(){"use strict";angular.module("wdt.controllers.appear-disappear",[]).controller("AppearDisappear",["$scope",function(a){a.weight=.01;var b=require("opencv"),c=document.getElementById("canvas"),d=c.getContext("2d"),e=document.getElementById("video-container"),f=document.getElementById("canvas-container"),g=320,h=240,i=0,j=new b.VideoCapture(i),k=new b.cvAverage;j.setWidth(g),j.setHeight(h),window.onresize=function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(b/g,c/h);f.style.webkitTransform="scale("+d+","+d+")";var i=(b-g)/2,j=(c-h)/2;e.style.left=""+i+"px",e.style.top=""+j+"px"},a.OSDOpacity=0;var l;a.showOSD=function(){a.OSDOpacity=1,l||(l=setInterval(function(){a.OSDOpacity*=.9,a.OSDOpacity<.01&&(a.OSDOpacity=0,clearInterval(l),l=void 0),a.$apply()},66))},document.onkeydown=function(c){switch(c.keyCode){case 38:a.weight=Math.min(1,a.weight+.005),a.showOSD();break;case 40:a.weight=Math.max(.005,a.weight-.005),a.showOSD();break;case 67:try{i+=1,j.close(),j=new b.VideoCapture(i)}catch(c){i=0,j=new b.VideoCapture(i)}j.setWidth(g),j.setHeight(h);break;case 81:j.close(),k=void 0,j=void 0,window.location="index.html";break;default:console.log("unhandled key code "+c.keyCode)}a.$apply()};var m=0,n=function(){j.read(function(b,c){k.process(c,a.weight);for(var e=d.createImageData(c.width(),c.height()),f=c.width(),g=c.height(),h=0;g>h;h+=1)for(var i=0;f>i;i+=1){var j=c.pixel(h,i),l=4*(f*h+i);e.data[l]=j[2],e.data[l+1]=j[1],e.data[l+2]=j[0],e.data[l+3]=255}d.putImageData(e,0,0),m+=1,window.setTimeout(n,10)})};window.onresize(),n()}])}(),function(){"use strict";angular.module("wdt.controllers.capture-replay",[]).controller("CaptureReplay",["$scope",function(a){function b(){i="countdown";var b,c=4;(b=function(){c--,0>=c?(i="record",j=[]):(a.toGo=c,setTimeout(b,1e3))})()}function c(){i="replay",m=0,n=1}function d(){i="reverse",m=l-1,n=-1}function e(){i="slowmotion",m=0,n=.33}var f=document.getElementById("canvas"),g=f.getContext("2d"),h=require("gstreamer-superficial"),i="menu",j=[],k=25,l=4*k,m=0,n=0,o=320,p=240,q={record:{x:.025,y:.525,w:.1,h:.1},replay:{x:.3,y:.525,w:.1,h:.1},reverse:{x:.45,y:.525,w:.1,h:.1},slowmotion:{x:.6,y:.525,w:.1,h:.1}},r="v4l2src ! tee name=t0  t0. ! queue max-size-buffers=1 ! videoconvert ! motion weight=0.3";for(var s in q){var t=q[s];r+=" ! triggers x="+t.x+" y="+t.y+" w="+t.w+" h="+t.h+" name="+s}r+=" ! fakesink  t0. ! queue max-size-buffers=1 ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink";var u=new h.Pipeline(r),v=u.findChild("sink");for(s in q)q[s].trigger=u.findChild(s);var w=document.getElementById("video-container"),x=document.getElementById("canvas-container"),y=document.getElementById("OSD");window.onresize=function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(b/o,c/p);x.style.webkitTransform="scale("+d+","+d+")";var e=(b-o)/2,f=(c-p)/2;w.style.left=""+e+"px",w.style.top=""+f+"px",y.style.left=""+(b-o*d)/2+"px",y.style.top=""+(c-p*d)/2+"px"},window.onresize(),document.onkeydown=function(f){switch(f.keyCode){case 82:b();break;case 65:c();break;case 83:d();break;case 68:e();break;case 81:u.stop(),window.location="index.html";break;default:console.log("unhandled key code "+f.keyCode)}a.$apply()},v.pull(function(b){var c=g.createImageData(o,p);switch(c.data.set(b),i){case"menu":g.putImageData(c,0,0);for(s in q){var d=q[s];g.fillStyle="rgba(255,0,0,"+d.trigger.get("value")+")",g.fillRect(d.x*o,d.y*p,d.w*o,d.h*p),g.strokeStyle="#f00",g.lineWidth=1,g.strokeRect(d.x*o,d.y*p,d.w*o,d.h*p),d.trigger.get("ping")&&console.log("PING "+s)}break;case"countdown":g.putImageData(c,0,0);break;case"record":g.putImageData(c,0,0),j.push(c),j.length>=l&&(i="menu"),a.toGo=(l-j.length)/k;break;case"replay":case"reverse":case"slowmotion":m+=n;var e=Math.round(m);0>e||e>=j.length?i="menu":g.putImageData(j[e],0,0),a.debug={pos:e,speed:n};break;default:g.clearRect(0,0,o,p)}a.mode=i,a.$apply()},function(a){}),a.$on("$routeChangeStart",function(a,b){a!==b&&u.stop()}),u.play()}])}(),function(){"use strict";angular.module("wdt.controllers.main",[]).controller("Main",["$scope",function(a){a.tools=[{name:"Matching Positions",href:"#/space/positions",img:"img/matching-positions.png"},{name:"Inertia",href:"#/space/inertia",img:"img/inertia.png"},{name:"Cage",href:"#/space/cage",img:"img/cage.png"},{name:"Appear - Disappear",href:"#/appear-disappear",img:"img/appear-disappear.png"}],a.toolRows=[];var b=[];for(var c in a.tools)b.push(a.tools[c]),3==b.length&&(a.toolRows.push(b),b=[]);a.toolRows.push(b),a.externalClick=function(a){var b=require("nw.gui");b.Shell.openExternal(a)},document.onkeydown=function(b){var c=b.keyCode-49;if(c>=0&&c<a.tools.length)return void(window.location=a.tools[c].href);switch(b.keyCode){case 81:default:console.log("unhandled key code "+b.keyCode)}}}])}(),function(){"use strict";angular.module("wdt.controllers.reverse-delay",[]).controller("ReverseDelay",["$scope",function(a){function b(a){a.beginPath(),a.moveTo(0,0),a.lineTo(3,7),a.lineTo(-3,7),a.closePath(),a.fill()}a.mode="Delay";var c=[],d=25,e=100,f=0,g=0,h=1;a.duration=e/d,a.changeBuffer=function(b){var i=e/d;switch(i+=b,1>i&&(i=1),i>10&&(i=10),e=i*d,c=[],a.mode){case"Delay":h=1,g=0,f=1;break;case"Reverse":h=-1,g=0,f=e-1}a.duration=i},a.switchMode=function(){"Delay"==a.mode?(a.mode="Reverse",h=-1,g=0,f=e-1):(a.mode="Delay",h=1,g=0,f=1)};var i=document.getElementById("canvas"),j=i.getContext("2d"),k=require("gstreamer-superficial"),l=320,m=240,n=new k.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),o=n.findChild("sink"),p=document.getElementById("video-container"),q=document.getElementById("canvas-container"),r=document.getElementById("OSD");window.onresize=function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(b/l,c/m);q.style.webkitTransform="scale("+d+","+d+")";var e=(b-l)/2,f=(c-m)/2;p.style.left=""+e+"px",p.style.top=""+f+"px",r.style.left=""+(b-l*d)/2+"px",r.style.top=""+(c-m*d)/2+"px"},window.onresize(),document.onkeydown=function(b){switch(b.keyCode){case 38:a.changeBuffer(1);break;case 40:a.changeBuffer(-1);break;case 39:a.switchMode();break;case 37:a.switchMode();break;case 81:n.stop(),window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()},o.pull(function(d){var i=j.createImageData(l,m);for(i.data.set(d),c[g]=i,g=(g+1)%e,f=(f+h)%e;0>f;)f=e-1;a.frames=c.length,a.playPosition=f,a.recordPosition=g,c.length>f?j.putImageData(c[f],0,0):j.clearRect(0,0,l,m);var k=150,n=10,o=150;j.strokeStyle="#fff",j.lineWidth=1,j.beginPath(),j.moveTo(k,n),j.lineTo(k+o,n),j.stroke(),j.save(),j.translate(k+o*g/e,n),j.fillStyle="#f00",b(j),j.restore(),j.save(),j.translate(k+o*f/e,n),j.fillStyle="#0f0",b(j),j.restore(),a.$apply()},function(a){}),a.$on("$routeChangeStart",function(a,b){a!==b&&n.stop()}),n.play()}])}(),function(){"use strict";angular.module("wdt.controllers.skel",[]).controller("Skel",["$scope",function(a){var b=document.getElementById("canvas"),c=b.getContext("2d"),d=require("gstreamer-superficial"),e=320,f=240,g=new d.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),h=g.findChild("sink"),i=document.getElementById("video-container"),j=document.getElementById("canvas-container"),k=document.getElementById("OSD");window.onresize=function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(b/e,c/f);j.style.webkitTransform="scale("+d+","+d+")";var g=(b-e)/2,h=(c-f)/2;i.style.left=""+g+"px",i.style.top=""+h+"px",k.style.left=""+(b-e*d)/2+"px",k.style.top=""+(c-f*d)/2+"px"},window.onresize(),document.onkeydown=function(b){switch(b.keyCode){case 81:g.stop(),window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()},h.pull(function(b){var d=c.createImageData(e,f);d.data.set(b),c.putImageData(d,0,0),a.$apply()},function(a){}),a.$on("$routeChangeStart",function(a,b){a!==b&&g.stop()}),g.play()}])}(),function(){"use strict";angular.module("wdt.controllers.space",[]).controller("Space",["$scope","$routeParams",function(a,b){function c(a){return a/180*-Math.PI}switch(b.spaceModule){case"inertia":a.exercises=[{type:"Inertia"}];break;case"cage":a.exercises=[{type:"Cage",left:.2,top:.2,right:.8,bottom:1.1},{type:"Cage",left:.35,top:.15,right:.6,bottom:1.1}];break;default:a.exercises=[{type:"StandAtAngle",angle:45},{type:"StandAtAngle",angle:0},{type:"StandAtAngle",angle:180},{type:"StandAtAngle",angle:316},{type:"MoveTo",x:.8,y:.7},{type:"StandAtAngle",angle:95},{type:"MoveTo",x:.1,y:.75},{type:"StandAtAngle",angle:212},{type:"StandAtAngle",angle:114},{type:"MoveTo",x:.9,y:.23}]}a.exerciseIndex=0,a.exercise=a.exercises[a.exerciseIndex],a.nextExercise=function(){a.exerciseIndex=(a.exerciseIndex+1)%a.exercises.length,a.exercise=a.exercises[a.exerciseIndex]},a.previousExercise=function(){a.exerciseIndex=(a.exerciseIndex-1)%a.exercises.length,a.exerciseIndex<0&&(a.exerciseIndex=a.exercises.length-1),a.exercise=a.exercises[a.exerciseIndex]},a.exerciseDone=function(){i.play(),a.nextExercise()},a.OSDOpacity=0;var d;a.showOSD=function(){a.OSDOpacity=1,d||(d=setInterval(function(){a.OSDOpacity*=.9,a.OSDOpacity<.01&&(a.OSDOpacity=0,clearInterval(d),d=void 0),a.$apply()},66))},a.threshold=100;var e=document.getElementById("canvas"),f=e.getContext("2d"),g=320,h=240;a.inert={x:g/2,y:h/2},a.vel={x:0,y:0};var i=new Audio("./snd/Robot_blip_2-Marianne_Gagnon-299056732.wav"),j=require("opencv"),k=0,l=new j.VideoCapture(k),m=new j.wExtremes,n=new j.cvMotion,o=new j.wAccumulate,p=new j.cvMultiplyS,q=new j.cvCamShift;l.setWidth(g),l.setHeight(h);var r=document.getElementById("video-container"),s=document.getElementById("canvas-container");window.onresize=function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(b/g,c/h);s.style.webkitTransform="scale("+d+","+d+")";var e=(b-g)/2,f=(c-h)/2;r.style.left=""+e+"px",r.style.top=""+f+"px"},document.onkeydown=function(b){switch(b.keyCode){case 38:a.threshold=Math.min(255,a.threshold+3),a.showOSD();break;case 40:a.threshold=Math.max(0,a.threshold-3),a.showOSD();break;case 39:a.nextExercise();break;case 37:a.previousExercise();break;case 32:n.reset();break;case 67:try{k+=1,l.close(),l=new j.VideoCapture(k)}catch(b){k=0,l=new j.VideoCapture(k)}l.setWidth(g),l.setHeight(h);break;case 81:l.close(),l=void 0,window.location="index.html";break;default:console.log("unhandled key code "+b.keyCode)}a.$apply()};var t=function(){l.read(function(b,d){d.convertGrayscale(),n.process(d,1e-6,2,-10,0),d=d.flip(1),d.gaussianBlur(),d=d.threshold(a.threshold,255),d.cvtColor("CV_GRAY2BGR");var e=m.process(d),g=q.process(d);o.process(d,.2,.8),p.process(d,.6,0);for(var h=f.createImageData(d.width(),d.height()),i=d.width(),j=d.height(),k=0;j>k;k+=1)for(var l=0;i>l;l+=1){var r=d.pixel(k,l),s=4*(i*k+l);h.data[s]=r[2],h.data[s+1]=r[1],h.data[s+2]=r[0],h.data[s+3]=255}f.putImageData(h,0,0);var u=a.extremes={left:e[0]*i,top:e[2]*j,right:e[1]*i,bottom:e[3]*j};if(!g)return void window.setTimeout(t,10);var v=a.centroid={x:Math.floor(g[0]*i),y:Math.floor(g[1]*j),width:Math.floor(g[2]*i),height:Math.floor(g[3]*j),angle:c(g[4])};f.fillStyle="#0f0",f.save(),f.translate(v.x,v.y),f.rotate(v.angle),f.fillRect(-(v.width/2),-5,v.width,10),f.fillRect(-5,-(v.height/2),10,v.height),f.restore(),f.strokeStyle="#f00",f.lineWidth=2,f.strokeRect(u.left,u.top,u.right-u.left,u.bottom-u.top);var w=.05,x=1-w,y=a.inert,z=a.vel,A={x:v.x-y.x,y:v.y-y.y};A.x*=w,A.y*=w,z.x*=x,z.y*=x,z.x+=A.x,z.y+=A.y,y.x+=z.x,y.y+=z.y,a.inert=y,a.vel=z;var B=a.exercise;f.fillStyle="#fff";var C=2,D=30;switch(f.save(),B.type){case"StandAtAngle":var E=c(B.angle);f.translate(i/2,j/2),f.rotate(E),f.fillRect(-i/2,-2,i,4);var F=Math.abs(E-v.angle);a.delta=F,F<Math.abs(c(3))&&a.exerciseDone();break;case"MoveTo":var l=B.x*i,k=B.y*j;f.fillRect(l-C,k-D,2*C,2*D),f.fillRect(l-D,k-C,2*D,2*C);var A={x:l-v.x,y:k-v.y},F=Math.sqrt(A.x*A.x+A.y*A.y);a.delta=F,10>F&&a.exerciseDone();break;case"Cage":var G={l:B.left*i,t:B.top*j,r:B.right*i,b:B.bottom*j},H=G.l<u.left&&G.t<u.top&&G.r>u.right&&G.b>=u.bottom;a.insideCage=H,f.strokeStyle=H?"#0f0":"#f00",f.lineWidth=2,f.strokeRect(G.l,G.t,G.r-G.l,G.b-G.t);break;case"Inertia":var l=a.inert.x,k=a.inert.y;f.fillRect(l-C,k-D,2*C,2*D),f.fillRect(l-D,k-C,2*D,2*C)}f.restore(),a.$apply(),window.setTimeout(t,10)})};a.$on("$routeChangeStart",function(a,b){a!==b&&(l.close(),l=void 0)}),window.onresize(),t()}])}();