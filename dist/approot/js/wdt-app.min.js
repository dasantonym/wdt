/**
 * wdt - Whatever Dance Toolbox
 * @version v2.0.0
 * @link https://github.com/dasantonym/wdt
 * @license GPL
 */
!function(){"use strict";angular.module("app",["ngRoute","wdt.controllers.appear-disappear","wdt.controllers.capture-replay","wdt.controllers.main","wdt.controllers.reverse-delay","wdt.controllers.skel","wdt.controllers.space"]).config(["$routeProvider","$logProvider",function(e,t){t.debugEnabled(!0);var n="views/";e.when("/",{templateUrl:n+"main.html",controller:"Main"}),e.when("/appear-disappear",{templateUrl:n+"appear-disappear.html",controller:"AppearDisappear"}),e.when("/capture-replay",{templateUrl:n+"capture-replay.html",controller:"CaptureReplay"}),e.when("/reverse-delay",{templateUrl:n+"reverse-delay.html",controller:"ReverseDelay"}),e.when("/space/:spaceModule",{templateUrl:n+"space.html",controller:"Space"})}]).run(function(){var e=require("nw.gui"),t=require("os"),n=e.Window.get(),a=new e.Menu({type:"menubar"});"darwin"===t.platform()&&(a.createMacBuiltin("WDT"),n.menu=a)})}(),function(){"use strict";angular.module("wdt.controllers.appear-disappear",[]).controller("AppearDisappear",["$scope",function(e){e.weight=.01;var t=require("wdt-native"),n=document.getElementById("canvas"),a=n.getContext("2d"),o=document.getElementById("video-container"),r=document.getElementById("canvas-container"),i=320,l=240,c=0,s=new t.VideoCapture(c),d=new t.cvAverage;s.setWidth(i),s.setHeight(l),window.onresize=function(e){var t=window.innerWidth,n=window.innerHeight,a=Math.min(t/i,n/l);r.style.webkitTransform="scale("+a+","+a+")";var c=(t-i)/2,s=(n-l)/2;o.style.left=""+c+"px",o.style.top=""+s+"px"},e.OSDOpacity=0;var p;e.showOSD=function(){e.OSDOpacity=1,p||(p=setInterval(function(){e.OSDOpacity*=.9,e.OSDOpacity<.01&&(e.OSDOpacity=0,clearInterval(p),p=void 0),e.$apply()},66))},document.onkeydown=function(n){switch(n.keyCode){case 38:e.weight=Math.min(1,e.weight+.005),e.showOSD();break;case 40:e.weight=Math.max(.005,e.weight-.005),e.showOSD();break;case 67:try{c+=1,s.close(),s=new t.VideoCapture(c)}catch(n){c=0,s=new t.VideoCapture(c)}s.setWidth(i),s.setHeight(l);break;case 81:s.close(),d=void 0,s=void 0,window.location="index.html";break;default:console.log("unhandled key code "+n.keyCode)}e.$apply()};var u=0,h=function(){s.read(function(t,n){d.process(n,e.weight);for(var o=a.createImageData(n.width(),n.height()),r=n.width(),i=n.height(),l=0;i>l;l+=1)for(var c=0;r>c;c+=1){var s=n.pixel(l,c),p=4*(r*l+c);o.data[p]=s[2],o.data[p+1]=s[1],o.data[p+2]=s[0],o.data[p+3]=255}a.putImageData(o,0,0),u+=1,window.setTimeout(h,10)})};window.onresize(),h()}])}(),function(){"use strict";angular.module("wdt.controllers.capture-replay",[]).controller("CaptureReplay",["$scope",function(e){function t(){l="countdown";var t,n=4;(t=function(){n--,0>=n?(l="record",c=[]):(e.toGo=n,setTimeout(t,1e3))})()}function n(){l="replay",p=0,u=1}function a(){l="reverse",p=d-1,u=-1}function o(){l="slowmotion",p=0,u=.33}{var r=document.getElementById("canvas"),i=r.getContext("2d"),l="menu",c=[],s=25,d=4*s,p=0,u=0,h=320,w=240,g={record:{x:.025,y:.525,w:.1,h:.1},replay:{x:.3,y:.525,w:.1,h:.1},reverse:{x:.45,y:.525,w:.1,h:.1},slowmotion:{x:.6,y:.525,w:.1,h:.1}},y=require("wdt-native"),f=0,m=new y.VideoCapture(f);new y.cvMotion}m.setWidth(h),m.setHeight(w);for(var v in g)g[v].trigger=new y.wTriggers;{var x=document.getElementById("video-container"),k=document.getElementById("canvas-container");document.getElementById("OSD")}window.onresize=function(e){var t=window.innerWidth,n=window.innerHeight,a=Math.min(t/h,n/w);k.style.webkitTransform="scale("+a+","+a+")";var o=(t-h)/2,r=(n-w)/2;x.style.left=""+o+"px",x.style.top=""+r+"px"},window.onresize(),document.onkeydown=function(r){switch(r.keyCode){case 82:t();break;case 65:n();break;case 83:a();break;case 68:o();break;case 81:window.location="index.html";break;default:console.log("unhandled key code "+r.keyCode)}e.$apply()},appsink.pull(function(t){var n=i.createImageData(h,w);switch(n.data.set(t),l){case"menu":i.putImageData(n,0,0);for(v in g){var a=g[v];i.fillStyle="rgba(255,0,0,"+a.trigger.get("value")+")",i.fillRect(a.x*h,a.y*w,a.w*h,a.h*w),i.strokeStyle="#f00",i.lineWidth=1,i.strokeRect(a.x*h,a.y*w,a.w*h,a.h*w),a.trigger.get("ping")&&console.log("PING "+v)}break;case"countdown":i.putImageData(n,0,0);break;case"record":i.putImageData(n,0,0),c.push(n),c.length>=d&&(l="menu"),e.toGo=(d-c.length)/s;break;case"replay":case"reverse":case"slowmotion":p+=u;var o=Math.round(p);0>o||o>=c.length?l="menu":i.putImageData(c[o],0,0),e.debug={pos:o,speed:u};break;default:i.clearRect(0,0,h,w)}e.mode=l,e.$apply()},function(e){}),e.$on("$routeChangeStart",function(e,t){e!==t&&pipeline.stop()}),pipeline.play()}])}(),function(){"use strict";angular.module("wdt.controllers.main",[]).controller("Main",["$scope",function(e){e.tools=[{name:"Matching Positions",href:"#/space/positions",img:"img/matching-positions.png"},{name:"Inertia",href:"#/space/inertia",img:"img/inertia.png"},{name:"Cage",href:"#/space/cage",img:"img/cage.png"},{name:"Appear - Disappear",href:"#/appear-disappear",img:"img/appear-disappear.png"}],e.toolRows=[];var t=[];for(var n in e.tools)t.push(e.tools[n]),3==t.length&&(e.toolRows.push(t),t=[]);e.toolRows.push(t),e.externalClick=function(e){var t=require("nw.gui");t.Shell.openExternal(e)},document.onkeydown=function(t){var n=t.keyCode-49;if(n>=0&&n<e.tools.length)return void(window.location=e.tools[n].href);switch(t.keyCode){case 81:default:console.log("unhandled key code "+t.keyCode)}}}])}(),function(){"use strict";angular.module("wdt.controllers.reverse-delay",[]).controller("ReverseDelay",["$scope",function(e){function t(e){e.beginPath(),e.moveTo(0,0),e.lineTo(3,7),e.lineTo(-3,7),e.closePath(),e.fill()}e.mode="Delay";var n=[],a=25,o=100,r=0,i=0,l=1;e.duration=o/a,e.changeBuffer=function(t){var c=o/a;switch(c+=t,1>c&&(c=1),c>10&&(c=10),o=c*a,n=[],e.mode){case"Delay":l=1,i=0,r=1;break;case"Reverse":l=-1,i=0,r=o-1}e.duration=c},e.switchMode=function(){"Delay"==e.mode?(e.mode="Reverse",l=-1,i=0,r=o-1):(e.mode="Delay",l=1,i=0,r=1)};var c=document.getElementById("canvas"),s=c.getContext("2d"),d=require("gstreamer-superficial"),p=320,u=240,h=new d.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),w=h.findChild("sink"),g=document.getElementById("video-container"),y=document.getElementById("canvas-container"),f=document.getElementById("OSD");window.onresize=function(e){var t=window.innerWidth,n=window.innerHeight,a=Math.min(t/p,n/u);y.style.webkitTransform="scale("+a+","+a+")";var o=(t-p)/2,r=(n-u)/2;g.style.left=""+o+"px",g.style.top=""+r+"px",f.style.left=""+(t-p*a)/2+"px",f.style.top=""+(n-u*a)/2+"px"},window.onresize(),document.onkeydown=function(t){switch(t.keyCode){case 38:e.changeBuffer(1);break;case 40:e.changeBuffer(-1);break;case 39:e.switchMode();break;case 37:e.switchMode();break;case 81:h.stop(),window.location="index.html";break;default:console.log("unhandled key code "+t.keyCode)}e.$apply()},w.pull(function(a){var c=s.createImageData(p,u);for(c.data.set(a),n[i]=c,i=(i+1)%o,r=(r+l)%o;0>r;)r=o-1;e.frames=n.length,e.playPosition=r,e.recordPosition=i,n.length>r?s.putImageData(n[r],0,0):s.clearRect(0,0,p,u);var d=150,h=10,w=150;s.strokeStyle="#fff",s.lineWidth=1,s.beginPath(),s.moveTo(d,h),s.lineTo(d+w,h),s.stroke(),s.save(),s.translate(d+w*i/o,h),s.fillStyle="#f00",t(s),s.restore(),s.save(),s.translate(d+w*r/o,h),s.fillStyle="#0f0",t(s),s.restore(),e.$apply()},function(e){}),e.$on("$routeChangeStart",function(e,t){e!==t&&h.stop()}),h.play()}])}(),function(){"use strict";angular.module("wdt.controllers.skel",[]).controller("Skel",["$scope",function(e){var t=document.getElementById("canvas"),n=t.getContext("2d"),a=require("gstreamer-superficial"),o=320,r=240,i=new a.Pipeline("v4l2src ! videoconvert ! video/x-raw, format=RGBA, width=320, height=240 ! appsink name=sink"),l=i.findChild("sink"),c=document.getElementById("video-container"),s=document.getElementById("canvas-container"),d=document.getElementById("OSD");window.onresize=function(e){var t=window.innerWidth,n=window.innerHeight,a=Math.min(t/o,n/r);s.style.webkitTransform="scale("+a+","+a+")";var i=(t-o)/2,l=(n-r)/2;c.style.left=""+i+"px",c.style.top=""+l+"px",d.style.left=""+(t-o*a)/2+"px",d.style.top=""+(n-r*a)/2+"px"},window.onresize(),document.onkeydown=function(t){switch(t.keyCode){case 81:i.stop(),window.location="index.html";break;default:console.log("unhandled key code "+t.keyCode)}e.$apply()},l.pull(function(t){var a=n.createImageData(o,r);a.data.set(t),n.putImageData(a,0,0),e.$apply()},function(e){}),e.$on("$routeChangeStart",function(e,t){e!==t&&i.stop()}),i.play()}])}(),function(){"use strict";angular.module("wdt.controllers.space",[]).controller("Space",["$scope","$routeParams",function(e,t){function n(e){return e/180*-Math.PI}switch(t.spaceModule){case"inertia":e.exercises=[{type:"Inertia"}];break;case"cage":e.exercises=[{type:"Cage",left:.2,top:.2,right:.8,bottom:1.1},{type:"Cage",left:.35,top:.15,right:.6,bottom:1.1}];break;default:e.exercises=[{type:"StandAtAngle",angle:45},{type:"StandAtAngle",angle:0},{type:"StandAtAngle",angle:180},{type:"StandAtAngle",angle:316},{type:"MoveTo",x:.8,y:.7},{type:"StandAtAngle",angle:95},{type:"MoveTo",x:.1,y:.75},{type:"StandAtAngle",angle:212},{type:"StandAtAngle",angle:114},{type:"MoveTo",x:.9,y:.23}]}e.exerciseIndex=0,e.exercise=e.exercises[e.exerciseIndex],e.nextExercise=function(){e.exerciseIndex=(e.exerciseIndex+1)%e.exercises.length,e.exercise=e.exercises[e.exerciseIndex]},e.previousExercise=function(){e.exerciseIndex=(e.exerciseIndex-1)%e.exercises.length,e.exerciseIndex<0&&(e.exerciseIndex=e.exercises.length-1),e.exercise=e.exercises[e.exerciseIndex]},e.exerciseDone=function(){c.play(),e.nextExercise()},e.OSDOpacity=0;var a;e.showOSD=function(){e.OSDOpacity=1,a||(a=setInterval(function(){e.OSDOpacity*=.9,e.OSDOpacity<.01&&(e.OSDOpacity=0,clearInterval(a),a=void 0),e.$apply()},66))},e.threshold=100;var o=document.getElementById("canvas"),r=o.getContext("2d"),i=320,l=240;e.inert={x:i/2,y:l/2},e.vel={x:0,y:0};var c=new Audio("./snd/Robot_blip_2-Marianne_Gagnon-299056732.wav"),s=require("wdt-native"),d=0,p=new s.VideoCapture(d),u=new s.wExtremes,h=new s.cvMotion,w=new s.wAccumulate,g=new s.cvMultiplyS,y=new s.cvCamShift;p.setWidth(i),p.setHeight(l);var f=document.getElementById("video-container"),m=document.getElementById("canvas-container");window.onresize=function(e){var t=window.innerWidth,n=window.innerHeight,a=Math.min(t/i,n/l);m.style.webkitTransform="scale("+a+","+a+")";var o=(t-i)/2,r=(n-l)/2;f.style.left=""+o+"px",f.style.top=""+r+"px"},document.onkeydown=function(t){switch(t.keyCode){case 38:e.threshold=Math.min(255,e.threshold+3),e.showOSD();break;case 40:e.threshold=Math.max(0,e.threshold-3),e.showOSD();break;case 39:e.nextExercise();break;case 37:e.previousExercise();break;case 32:h.reset();break;case 67:try{d+=1,p.close(),p=new s.VideoCapture(d)}catch(t){d=0,p=new s.VideoCapture(d)}p.setWidth(i),p.setHeight(l);break;case 81:p.close(),p=void 0,window.location="index.html";break;default:console.log("unhandled key code "+t.keyCode)}e.$apply()};var v=function(){p.read(function(t,a){a.convertGrayscale(),h.process(a,1e-6,2,-10,0),a=a.flip(1),a.gaussianBlur(),a=a.threshold(e.threshold,255),a.cvtColor("CV_GRAY2BGR");var o=u.process(a),i=y.process(a);w.process(a,.2,.8),g.process(a,.6,0);for(var l=r.createImageData(a.width(),a.height()),c=a.width(),s=a.height(),d=0;s>d;d+=1)for(var p=0;c>p;p+=1){var f=a.pixel(d,p),m=4*(c*d+p);l.data[m]=f[2],l.data[m+1]=f[1],l.data[m+2]=f[0],l.data[m+3]=255}r.putImageData(l,0,0);var x=e.extremes={left:o[0]*c,top:o[2]*s,right:o[1]*c,bottom:o[3]*s};if(!i)return void window.setTimeout(v,10);var k=e.centroid={x:Math.floor(i[0]*c),y:Math.floor(i[1]*s),width:Math.floor(i[2]*c),height:Math.floor(i[3]*s),angle:n(i[4])};r.fillStyle="#0f0",r.save(),r.translate(k.x,k.y),r.rotate(k.angle),r.fillRect(-(k.width/2),-5,k.width,10),r.fillRect(-5,-(k.height/2),10,k.height),r.restore(),r.strokeStyle="#f00",r.lineWidth=2,r.strokeRect(x.left,x.top,x.right-x.left,x.bottom-x.top);var b=.05,I=1-b,S=e.inert,D=e.vel,C={x:k.x-S.x,y:k.y-S.y};C.x*=b,C.y*=b,D.x*=I,D.y*=I,D.x+=C.x,D.y+=C.y,S.x+=D.x,S.y+=D.y,e.inert=S,e.vel=D;var M=e.exercise;r.fillStyle="#fff";var O=2,R=30;switch(r.save(),M.type){case"StandAtAngle":var $=n(M.angle);r.translate(c/2,s/2),r.rotate($),r.fillRect(-c/2,-2,c,4);var B=Math.abs($-k.angle);e.delta=B,B<Math.abs(n(3))&&e.exerciseDone();break;case"MoveTo":var p=M.x*c,d=M.y*s;r.fillRect(p-O,d-R,2*O,2*R),r.fillRect(p-R,d-O,2*R,2*O);var C={x:p-k.x,y:d-k.y},B=Math.sqrt(C.x*C.x+C.y*C.y);e.delta=B,10>B&&e.exerciseDone();break;case"Cage":var E={l:M.left*c,t:M.top*s,r:M.right*c,b:M.bottom*s},A=E.l<x.left&&E.t<x.top&&E.r>x.right&&E.b>=x.bottom;e.insideCage=A,r.strokeStyle=A?"#0f0":"#f00",r.lineWidth=2,r.strokeRect(E.l,E.t,E.r-E.l,E.b-E.t);break;case"Inertia":var p=e.inert.x,d=e.inert.y;r.fillRect(p-O,d-R,2*O,2*R),r.fillRect(p-R,d-O,2*R,2*O)}r.restore(),e.$apply(),window.setTimeout(v,10)})};e.$on("$routeChangeStart",function(e,t){e!==t&&(p.close(),p=void 0)}),window.onresize(),v()}])}();